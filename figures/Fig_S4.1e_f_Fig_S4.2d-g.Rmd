---
title: "Figure S4.1e,f and S4.2 d-g - reproducibility script"
author: "Wangjie Liu"
date: "2024-03-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "./")
getwd()
```

## Libraries & functions

First, I'm loading the required libraries & functions

```{r}
suppressPackageStartupMessages(library(Seurat, lib.loc = "~/.local/share/")) 
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(ggplot2)) 
suppressPackageStartupMessages(library(tidyverse)) 
suppressPackageStartupMessages(library(gridExtra)) 
suppressPackageStartupMessages(library(viridis)) 
suppressPackageStartupMessages(library(monocle3)) 
suppressPackageStartupMessages(library(crayon)) 

cat(bold("Seurat"), "version", as.character(packageVersion("Seurat")), "\n")
cat(bold("data.table"), "version", as.character(packageVersion("data.table")), "\n")
cat(bold("ggplot2"), "version", as.character(packageVersion("ggplot2")), "\n")
cat(bold("tidyverse"), "version", as.character(packageVersion("tidyverse")), "\n")
cat(bold("gridExtra"), "version", as.character(packageVersion("gridExtra")), "\n")
cat(bold("viridis"), "version", as.character(packageVersion("viridis")), "\n")
cat(bold("monocle3"), "version", as.character(packageVersion("monocle3")), "\n")

# Seurat version 4.4.0 
# data.table version 1.14.8 
# ggplot2 version 3.4.3 
# tidyverse version 2.0.0 
# gridExtra version 2.3 
# viridis version 0.6.4 
# monocle3 version 1.0.0 
```

## read the functional TF atlas in G1 (default phase)

```{r}
seu_funct <- readRDS("results/C3H10_10X_all_exps_integrated_functional_TF_atlas_G1_Phase.rds")
dim(seu_funct)
```

# Figure S4.1e - upper panel

```{r Fig_S4.1e_up}
TFoi <- c("Egr1","Esr2","Etv1")
p_TFoi <- lapply(TFoi, function(x){
  p <- DimPlot(seu_funct, cells.highlight = colnames(seu_funct)[seu_funct$TF == x], cols = "gray85", cols.highlight = "red", sizes.highlight = 1, pt.size = 0.1)+
    theme(axis.line = element_blank(),
    legend.position = "none", 
    panel.grid.major=element_blank(), 
    panel.grid.minor=element_blank(), 
    axis.text=element_blank(), 
    axis.ticks=element_blank(), 
    plot.background=element_blank(), 
    panel.background=element_blank())+
    xlab(label = "") + ylab(label = "")+
    labs(title = x)
  return(p)
})
p_TFoi

pdf("figures/Fig_S4.1e_up.pdf", width = 10, height = 8)
marrangeGrob(p_TFoi, ncol = 2, nrow = 2)
dev.off()
```

# Figure S4.2d,e - upper panel & Figure S4.2g

```{r}
TFoi <- c("Meis2","Myog","Grhl2")
p_TFoi <- lapply(TFoi, function(x){
  p <- DimPlot(seu_funct, cells.highlight = colnames(seu_funct)[seu_funct$TF == x],cols = "gray85", cols.highlight = "darkgreen", sizes.highlight = 1, pt.size = 0.1)+
    theme(axis.line = element_blank(),
    legend.position = "none", 
    panel.grid.major=element_blank(), 
    panel.grid.minor=element_blank(), 
    axis.text=element_blank(), 
    axis.ticks=element_blank(), 
    plot.background=element_blank(), 
    panel.background=element_blank())+
    xlab(label = "") + ylab(label = "")+
    labs(title = x)
  return(p)
})
p_TFoi

pdf("figures/Fig_S4.2d_e_up_Fig_S4.2g.pdf", width = 10, height = 8)
marrangeGrob(p_TFoi, ncol = 2, nrow = 2)
dev.off()
```

# cell fate branching analysis on (phase adjusted) G1 cells of TF of interest and batch-paired control

## read the annotation file

```{r}
data.annot <- fread("metadata/GRCm38_gene_annot.tsv", data.table = F) 
rownames(data.annot) <- data.annot$ensembl_id
```

## read the whole scTF-seq atlas

```{r}
seu <- readRDS("results/C3H10_10X_all_exps_merged_genefiltered_integrated_functional.rds")
dim(seu)
```

## subset to G1 (Phase adjusted) cells for TF of interest + batch-paired control

```{r}
# subset seurat object to G1
seu <- subset(seu, Phase_corrected == "G1")
DefaultAssay(seu) <- "RNA"
```

```{r}
# subset to TFoi + ctr (D0+D0_confluent) cells in G1
TFoi <- "Grhl2"
batch.oi <- table(seu$batch[seu$TF == TFoi]) %>% names()
seu.oi <- subset(seu, TF %in% c("D0","D0_confluent", TFoi) & batch %in% batch.oi)
seu.oi$TF <- factor(seu.oi$TF, levels = c("D0","D0_confluent",TFoi))
dim(seu.oi)
table(seu.oi$TF)
```

```{r}
# monocle single-cell analysis pipeline
cell.meta <- seu.oi@meta.data[, c("nCount_RNA","nFeature_RNA","Phase_corrected","batch","Dose","TF")]
gene.meta <- data.frame(ens_id = rownames(seu.oi@assays$RNA@counts), gene_short_name = data.annot[rownames(seu.oi@assays$RNA@counts),"gene_symbol"], gene_type = data.annot[rownames(seu.oi@assays$RNA@counts), "biotype"])
rownames(gene.meta) <- rownames(seu.oi@assays$RNA@counts)
cds <- new_cell_data_set(expression_data = seu.oi@assays$RNA@counts, 
                         cell_metadata = cell.meta,
                         gene_metadata = gene.meta)
```
```{r}
set.seed(10)
cds <- preprocess_cds(cds, num_dim = 30) # dimensionality of the reduced space
# for Kf4, Grhl2, num_dim = 30,
# for Etv1, num_dim = 30
# for Esr2, num_dim = 50
# for Myog, num_dim = 30
# for Runx2, num_dim = 50
# for Egr1, num_dim = 30
# for Meis2 num_dim = 30
# for Foxa1 num_dim = 50
#remove batch
if (length(batch.oi) > 1){
  cds <- align_cds(cds, alignment_group = "batch")  
}
cds <- reduce_dimension(cds)

```

```{r}
plot_pc_variance_explained(cds)
```

```{r}
set.seed(10)
cds <- cluster_cells(cds, resolution = 0.3)
```

```{r}
plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = F, cell_size = 2, label_cell_groups = F) 
plot_cells(cds, color_cells_by = "TF", show_trajectory_graph = F, cell_size = 2, label_cell_groups = F) 
# plot_cells(cds, color_cells_by = "batch", show_trajectory_graph = F, cell_size = 2, label_cell_groups = F) 
```

```{r}
cells_2 <- names(cds@clusters$UMAP$clusters)[cds@clusters$UMAP$clusters == 2]
cells_7 <- names(cds@clusters$UMAP$clusters)[cds@clusters$UMAP$clusters == 7]
cells_10 <- names(cds@clusters$UMAP$clusters)[cds@clusters$UMAP$clusters == 10]
DimPlot(seu_funct, cells.highlight = cells_2)
DimPlot(seu_funct, cells.highlight = cells_7)
DimPlot(seu_funct, cells.highlight = cells_10)
```

```{r}
cds <- learn_graph(cds)
cds <- order_cells(cds)
```

```{r}
p.vector <- plot_cells(cds, color_cells_by = "log_vector", cell_size = 2, show_trajectory_graph = F)+
  scale_color_continuous(type = "viridis")
p.TF <- plot_cells(cds, color_cells_by = "TF", cell_size = 2, label_cell_groups = F, show_trajectory_graph = F)+
  scale_color_manual(values = c("lightgrey","#66cc99")) 
# c("lightgrey","#996600","#FF9933")
# blue for Klf4, darkgreen for Grhl2 
# #9999FF purple-like for Esr2
# #3399FF blue
# #cab2d6 purple Myog
# #b3cde3 Egr1
# "#7570b3" Meis2
# #CCCC00 Foxa1
# 66cc99 Etv1
p.pseudo <- plot_cells(cds, color_cells_by = "pseudotime", cell_size = 2, show_trajectory_graph = F)
```


